<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web IOT - Gi√°m S√°t D·ªØ Li·ªáu</title>
    
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüì°%3C/text%3E%3C/svg%3E">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        /* B∆Ø·ªöC 2: CSS PH√ô H·ª¢P V·ªöI ƒê·ªÄ B√ÄI (CH·ª¶ ƒê·ªÄ T·ªêI - DARK THEME) */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a2e; /* N·ªÅn t·ªëi (li√™n quan ƒë·∫øn c√¥ng ngh·ªá) */
            color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            margin: auto;
            background: #2a2a3e; /* M√†u n·ªÅn card */
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            border: 1px solid #444;
        }
        .page { display: none; margin-top: 20px; }
        .alert {
            padding: 12px;
            margin-bottom: 15px;
            border-radius: 6px;
            border: 1px solid transparent;
            font-weight: bold;
        }
        .alert-error { background-color: #5a1d24; color: #f8d7da; border-color: #f5c6cb; }
        .alert-success { background-color: #1e4b2e; color: #d4edda; border-color: #c3e6cb; }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            background-color: #007bff;
            color: white;
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
        }
        button:hover { background-color: #0056b3; }
        button:active { transform: scale(0.98); }
        
        .input-group {
            position: relative;
            margin-bottom: 15px;
        }
        .input-group i {
            position: absolute;
            left: 15px;
            top: 14px;
            color: #888;
        }
        input[type="text"], input[type="password"] {
            padding: 12px 12px 12px 40px; /* Th√™m padding cho icon */
            width: calc(100% - 54px); /* ƒêi·ªÅu ch·ªânh width */
            border: 1px solid #555;
            border-radius: 6px;
            font-size: 16px;
            background-color: #1a1a2e;
            color: #f0f0f0;
        }
        
        .data-box {
            border: 1px solid #444;
            padding: 20px;
            margin-top: 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
        }
        .data-box:hover { background-color: #3a3a4e; }
        .data-box i {
            font-size: 24px;
            margin-right: 15px;
        }
        .data-box strong { font-size: 1.2em; }
        #temp-value { color: #f08080; } /* M√†u ƒë·ªè nh·∫°t cho nhi·ªát ƒë·ªô */
        #humid-value { color: #87ceeb; } /* M√†u xanh nh·∫°t cho ƒë·ªô ·∫©m */
        
        #grafana-container { margin-top: 20px; text-align: center; }
        #grafana-iframe {
            width: 100%;
            height: 400px;
            border: 1px solid #444;
            border-radius: 8px;
            background-color: #fff; /* N·ªÅn tr·∫Øng cho iframe Grafana (n·∫øu theme s√°ng) */
        }
        a { color: #8ab4f8; text-decoration: none; }
        a:hover { text-decoration: underline; }
        h1, h2 { color: #ffffff; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        .logout-button { background-color: #d9534f; }
        .logout-button:hover { background-color: #c9302c; }
    </style>
</head>
<body>
    <div class="container">
        <h1><i class="fas fa-satellite-dish"></i> H·ªá Th·ªëng Gi√°m S√°t IoT (58KTPM)</h1>
        
        <div id="login-page" class="page" style="display: block;">
            <h2><i class="fas fa-sign-in-alt"></i> ƒêƒÉng nh·∫≠p</h2>
            <div id="login-alert" class="alert" style="display: none;"></div>
            <form id="login-form">
                <div class="input-group">
                    <i class="fas fa-user"></i>
                    <input type="text" id="login-username" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-lock"></i>
                    <input type="password" id="login-password" placeholder="M·∫≠t kh·∫©u" required>
                </div>
                <button type="submit"><i class="fas fa-arrow-right"></i> ƒêƒÉng Nh·∫≠p</button>
            </form>
            <p><a href="#" onclick="showPage('register')">ƒêƒÉng k√Ω t√†i kho·∫£n m·ªõi</a> | <a href="#" onclick="showPage('forgot')">Qu√™n m·∫≠t kh·∫©u</a></p>
        </div>

        <div id="register-page" class="page">
            <h2><i class="fas fa-user-plus"></i> ƒêƒÉng k√Ω</h2>
            <div id="register-alert" class="alert" style="display: none;"></div>
            <form id="register-form">
                <div class="input-group">
                    <i class="fas fa-user-shield"></i>
                    <input type="text" id="reg-username" placeholder="T√™n ƒëƒÉng nh·∫≠p" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-key"></i>
                    <input type="password" id="reg-password" placeholder="M·∫≠t kh·∫©u" required>
                </div>
                <div class="input-group">
                    <i class="fas fa-redo-alt"></i>
                    <input type="password" id="reg-retype" placeholder="Ghi l·∫°i m·∫≠t kh·∫©u" required>
                </div>
                <button type="submit"><i class="fas fa-check"></i> ƒêƒÉng K√Ω</button>
            </form>
            <p><a href="#" onclick="showPage('login')">Quay l·∫°i ƒêƒÉng nh·∫≠p</a></p>
        </div>

        <div id="dashboard-page" class="page">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h2>Ch√†o m·ª´ng, <span id="welcome-user"></span>!</h2>
                <button onclick="logout()" class="logout-button"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng Xu·∫•t</button>
            </div>
            
            <div id="data-container">
                <div class="data-box" onclick="showChart('temperature')">
                    <i class="fas fa-temperature-half" style="color: #f08080;"></i>
                    <span>Nhi·ªát ƒë·ªô: <strong id="temp-value">--</strong> ¬∞C</span>
                </div>
                <div class="data-box" onclick="showChart('humidity')">
                    <i class="fas fa-tint" style="color: #87ceeb;"></i>
                    <span>ƒê·ªô ·∫©m: <strong id="humid-value">--</strong> %</span>
                </div>
            </div>

            <div id="grafana-container">
                <h3><i class="fas fa-chart-line"></i> ƒê·ªì th·ªã L·ªãch s·ª≠ (<span id="chart-title"></span>)</h3>
                <iframe id="grafana-iframe" style="display:none;" title="Grafana Chart"></iframe>
                <p id="grafana-note">Click v√†o th√¥ng s·ªë ƒë·ªÉ hi·ªÉn th·ªã ƒë·ªì th·ªã l·ªãch s·ª≠.</p>
            </div>
        </div>

        <div id="forgot-page" class="page">
            <h2>Qu√™n m·∫≠t kh·∫©u</h2>
            <form id="forgot-form">
                <div class="input-group">
                    <i class="fas fa-envelope"></i>
                    <input type="text" id="forgot-username" placeholder="T√™n ƒëƒÉng nh·∫≠p (Email)" required>
                </div>
                <button type="submit">Y√™u c·∫ßu Reset</button>
            </form>
            <p><a href="#" onclick="showPage('login')">Quay l·∫°i ƒêƒÉng nh·∫≠p</a></p>
        </div>

    </div>

    <script>
        // ƒê·ªãa ch·ªâ g·ªëc c·ªßa API, kh·ªõp v·ªõi Nginx
        const API_ROOT = '/api'; // Kh√¥ng c·∫ßn http://phuomgnam.com

        // --- H√†m Qu·∫£n l√Ω Giao di·ªán ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.style.display = 'none');
            document.getElementById(pageId + '-page').style.display = 'block';
        }

        function showAlert(alertId, message, isError = true) {
            const alert = document.getElementById(alertId);
            alert.className = isError ? 'alert alert-error' : 'alert alert-success';
            alert.textContent = message;
            alert.style.display = 'block';
        }

        // --- Qu·∫£n l√Ω Phi√™n ƒêƒÉng nh·∫≠p (Session) ---
        function checkLoginStatus() {
            const token = sessionStorage.getItem('authToken');
            if (token) {
                document.getElementById('welcome-user').textContent = sessionStorage.getItem('username') || 'Ng∆∞·ªùi d√πng';
                showPage('dashboard');
                fetchLatestData(); // B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu sau khi ƒëƒÉng nh·∫≠p
                // C·ª© 10 gi√¢y t·∫£i l·∫°i 1 l·∫ßn
                window.dataInterval = setInterval(fetchLatestData, 10000);
            } else {
                showPage('login');
            }
        }
        
        function logout() {
            sessionStorage.removeItem('authToken');
            sessionStorage.removeItem('username');
            if (window.dataInterval) {
                clearInterval(window.dataInterval);
            }
            showPage('login');
        }

        // --- Ch·ª©c nƒÉng IoT: G·ªçi API v√† Hi·ªÉn th·ªã ---
        function fetchLatestData() {
            const token = sessionStorage.getItem('authToken');
            fetch(API_ROOT + '/latest-data', {
                headers: {
                    'Authorization': 'Bearer ' + token // G·ª≠i token (n·∫øu API y√™u c·∫ßu)
                }
            })
            .then(response => {
                if (!response.ok) throw new Error('Network response was not ok');
                return response.json();
            })
            .then(data => {
                if (Array.isArray(data)) {
                    const temp = data.find(item => item.name === 'temperature');
                    const humid = data.find(item => item.name === 'humidity');

                    if (temp) document.getElementById('temp-value').textContent = parseFloat(temp.value).toFixed(2);
                    if (humid) document.getElementById('humid-value').textContent = parseFloat(humid.value).toFixed(2);
                }
            })
            .catch(error => {
                console.error('L·ªói t·∫£i d·ªØ li·ªáu:', error);
                // N·∫øu 0.00% l√† do Flow 1 (IoT Core) ch∆∞a ƒë∆∞·ª£c Deploy trong Node-RED
                if (document.getElementById('temp-value').textContent === '--') {
                    document.getElementById('temp-value').textContent = '0.00 (Flow 1 ch∆∞a Deploy)';
                    document.getElementById('humid-value').textContent = '0.00 (Flow 1 ch∆∞a Deploy)';
                }
            });
        }

        // --- Ch·ª©c nƒÉng Grafana (G·ªçi iframe) ---
        function showChart(metric) {
            const title = metric === 'temperature' ? 'Nhi·ªát ƒë·ªô' : 'ƒê·ªô ·∫©m';
            document.getElementById('chart-title').textContent = title;

            // !!! B·∫†N PH·∫¢I THAY TH·∫æ LINK N√ÄY !!!
            // V√†o Grafana -> Share Panel -> Embed -> Copy link 'src'
            // Link m·∫´u (S·∫º KH√îNG CH·∫†Y):
            const IFRAME_SRC = `http://phuongnam.com/grafana/d-solo/YOUR_DASHBOARD_ID/iot-dashboard?orgId=1&panelId=YOUR_PANEL_ID&theme=dark`; // ƒê·ªïi theme=dark

            document.getElementById('grafana-iframe').src = IFRAME_SRC; 
            document.getElementById('grafana-iframe').style.display = 'block';
            document.getElementById('grafana-note').style.display = 'none';
        }
        
        // --- X·ª≠ l√Ω POST (H√†m helper) ---
        async function postData(url, data) {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (!response.ok && response.status !== 400 && response.status !== 401 && response.status !== 404) {
                throw new Error('L·ªói m·∫°ng ho·∫∑c server kh√¥ng ph·∫£n h·ªìi.');
            }
            return response.json();
        }

        // --- X·ª≠ l√Ω ƒêƒÉng k√Ω ---
        document.getElementById('register-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('reg-username').value;
            const pass = document.getElementById('reg-password').value;
            const re_pass = document.getElementById('reg-retype').value;

            if (pass !== re_pass) {
                showAlert('register-alert', 'M·∫≠t kh·∫©u nh·∫≠p l·∫°i kh√¥ng kh·ªõp.');
                return;
            }

            try {
                const data = await postData(API_ROOT + '/register', {
                    username: user, password: pass, retype_password: re_pass 
                });
                
                showAlert('register-alert', data.message, !data.success);
                if (data.success) {
                    setTimeout(() => showPage('login'), 2000);
                }
            } catch(err) {
                showAlert('register-alert', err.message);
            }
        });

        // --- X·ª≠ l√Ω ƒêƒÉng nh·∫≠p ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = document.getElementById('login-username').value;
            const pass = document.getElementById('login-password').value;
            
            try {
                const data = await postData(API_ROOT + '/login', { username: user, password: pass });
                
                if (data.success) {
                    sessionStorage.setItem('authToken', data.token);
                    sessionStorage.setItem('username', data.user.username);
                    checkLoginStatus(); // Chuy·ªÉn trang
                } else {
                    showAlert('login-alert', data.message);
                }
            } catch(err) {
                showAlert('login-alert', err.message);
            }
        });
        
        // --- X·ª≠ l√Ω Qu√™n M·∫≠t kh·∫©u ---
        // (Form 'forgot-form' ƒë√£ ƒë∆∞·ª£c th√™m)
        document.getElementById('forgot-form').addEventListener('submit', async (e) => {
             e.preventDefault();
             const user = document.getElementById('forgot-username').value;
             try {
                const data = await postData(API_ROOT + '/forgot-password', { username: user });
                showAlert('forgot-alert', "N·∫øu t√†i kho·∫£n t·ªìn t·∫°i, h∆∞·ªõng d·∫´n reset ƒë√£ ƒë∆∞·ª£c g·ª≠i (gi·∫£ l·∫≠p).", false);
            } catch(err) {
                 showAlert('forgot-alert', err.message);
            }
        });

        // Kh·ªüi ƒë·ªông
        document.addEventListener('DOMContentLoaded', checkLoginStatus);
    </script>
</body>
</html>